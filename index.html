<!Doctype html>
<html>
    <head>
        <title>grapnel ninja</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <meta charset = "UTF-8">
        <style>
            body 
            {
                margin: 0;
                padding: 0;
                overflow: hidden;
                background-color: 0;
            }
        </style>
        <script src = "konva.min.js"></script>
    </head>
    <body>
        <script src = "gameoptions.js"></script>
        
        <script src = "collision/circlewithline.js"></script>
        <script src = "collision/linewithline.js"></script>
        
        <script src = "sprites/sprite.js"></script>
        <script src = "sprites/ninja.js"></script>
        <script src = "sprites/grapnel.js"></script>
        
        <script src = "physics.js"></script>
        <script src = "sides.js"></script>
        
        <script src = "obstacles/generate.js"></script>
        <script src = "obstacles/delete.js"></script>
        <script src = "moveScreen.js"></script>
        <div id = "container"></div>
        <script>
            'use strict'
            let stage = new Konva.Stage({
                container: 'container',
                width: width,
                height: height
            })
            Konva.pixelRatio = 1
            
            let grapnelLayer = new Konva.Layer()
            let ninjaLayer = new Konva.Layer()
            let staticLayer = new Konva.Layer()
            let obstaclesLayer = new Konva.Layer()
            let mechanicsLayer = new Konva.Layer()
            
            stage.add(grapnelLayer)
            stage.add(staticLayer)
            stage.add(ninjaLayer)
            stage.add(obstaclesLayer)
            
            stage.add(mechanicsLayer)
            
            let ninja = new Ninja(new Konva.Circle({
                x: 0.2 * width,
                y: 0.2 * height,
                radius: 10,
                fill: '#0000ff',
                stroke: '#000000',
                strokeWidth: 1
            }))
            
            let grapnel = new Grapnel(new Konva.Line({
                points: [0, 0, 0, 0],
                stroke: 'red',
                strokeWidth: 5,
                lineJoin: 'round'
            }))
            let screen = new Screen()
            
            ninjaLayer.add(ninja.object)
            staticLayer.add(sprites[0].object, sprites[1].object)
            grapnelLayer.add(grapnel.object)
            
            mechanicsLayer.add(new Konva.Line({
                points: [screen.whereMove, 0.2 * height, screen.whereMove, 0.8 * height],
                stroke: 'green',
                strokeWidth: 3,
                lineJoin: 'round'
            }))
            mechanicsLayer.add(new Konva.Line({
                points: [screen.whenceMove, 0.2 * height, screen.whenceMove, 0.8 * height],
                stroke: 'green',
                strokeWidth: 3,
                lineJoin: 'round',
                opacity: 0.5
            }))
            mechanicsLayer.add(new Konva.Line({
                points: [screen.lastBarrierMove, 0.2 * height, screen.lastBarrierMove, 0.8 * height],
                stroke: 'green',
                strokeWidth: 5,
                lineJoin: 'round'
            }))
            staticLayer.draw()
            mechanicsLayer.draw()
            
            let x = 0.4 * width
            for (let i = 0; i < 5; ++i)
            {
                generateObstacle(x + (obstacleIndent + obstacleWidth) * i)
            }
            
            
            stage.on('mousedown', function()
            {
                if (grapnel.throwed)
                {
                    grapnel.x = NaN
                    grapnel.y = NaN
                }
                else
                {
                    grapnel.x = ninja.x
                    grapnel.y = ninja.y
                    let ratio = grapnel.calcSpeed(stage.getPointerPosition())
                    grapnel.speedY = ratio.sin * grapnelSpeed
                    grapnel.speedX = ratio.cos * grapnelSpeed
                }
                grapnel.throwed = !grapnel.throwed
            })
            function gameLoop()
            {
                /*for (let i = 0; i < cyclesPerTick; ++i)
                {
                    physics()
                }*/
                physics()
                if (grapnel.throwed)
                {
                    grapnelLayer.visible(true)
                    grapnelLayer.draw()
                }
                else
                    grapnelLayer.visible(false)
                ninjaLayer.draw()
                //staticLayer.draw()
                //mechanicsLayer.draw()
                obstaclesLayer.draw()
                
                
                
                requestAnimationFrame(gameLoop)
            }
            requestAnimationFrame(gameLoop)
        </script>
    </body>
</html>